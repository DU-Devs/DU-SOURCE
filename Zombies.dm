/*
zombies arent reproducing or mutating correctly

add zombie sounds
*/

mob/var/Zombie_Immune=0
mob/var/Flyer
mob/var/Zombie_Virus=0
mob/var/Zombie_Power=0
mob/proc/Mutate(A)
	if(!A) A=rand(2,13)
	Flyer=0
	//NPC Scorpion 2.dmi, NPC Spider 3.dmi, NPC Snake.dmi
	//RP_Power, Str, Dur, Res, Spd, Off, Def
	if(A==2)
		name="Zombie Dog"
		icon='Zombie Dog.dmi'
		BP*=1.2
		Spd*=1.2
		spdmod*=1.2
	if(A==3)
		name="Licker"
		icon='Zombie Licker.dmi'
		Zombie_Virus=5
		BP*=1.5
		Spd*=1.5
		spdmod*=1.5
		Off*=1.5
		offmod*=1.5
		npc_move_delay=2.5
		if(prob(20))
			Enlarge_Icon(48,48)
			Center_Icon(src)
	if(A==4)
		name="Hunter"
		icon='Zombie Hunter.dmi'
		Zombie_Virus=1
		BP*=1.5
		Str*=2
		strmod*=2
		End*=1.5
		endmod*=1.5
		Res*=0.5
		resmod*=0.5
		if(prob(20))
			Enlarge_Icon(48,48)
			Center_Icon(src)
	if(A==5)
		name="Tyrant"
		icon='Zombie Tyrant.dmi'
		Zombie_Virus=20
		BP*=2
		End*=1.5
		endmod*=1.5
		Spd*=1.5
		spdmod*=1.5
	if(A==6)
		name="Nemesis"
		icon='Zombie Nemesis.dmi'
		Zombie_Virus=1
		BP*=2
		End*=3
		endmod*=3
		Str*=1.5
		strmod*=1.5
		Res*=3
		resmod*=3
		npc_move_delay=7
		if(prob(30))
			Enlarge_Icon(48,48)
			Center_Icon(src)
	if(A==7)
		name="Mr X"
		icon='Zombie X.dmi'
		Zombie_Virus=10
		BP*=3
		spdmod*=2
		Spd*=2
		Off*=2
		offmod*=2
	if(A==8)
		name="Thanatos"
		icon='Zombie Thanatos.dmi'
		Zombie_Virus=10
		BP*=3
		Str*=2
		strmod*=2
		Spd*=1.5
		spdmod*=1.5
		npc_move_delay=4
	if(A==9)
		name="Gargoyle"
		icon='Gargoyle.dmi'
		Zombie_Virus=1
		endmod*=0.5
		End*=0.5
		Res*=0.2
		resmod*=0.2
		Spd*=3
		spdmod*=3
		Flyer=1
	if(A==10)
		name="Reptile Zombie"
		icon='NPC Reptile Monster.dmi'
		Zombie_Virus=1
		BP*=1.3
		Spd*=2
		spdmod*=2
		Res*=0.5
		resmod*=0.5
	if(A==11)
		name="Snake Zombie"
		icon='NPC Snake.dmi'
		Zombie_Virus=0.5
		Spd*=3
		spdmod*=3
	if(A==12)
		name="Scorpion Zombie"
		icon='NPC Scorpion 2.dmi'
		Zombie_Virus*=0.5
		End*=3
		endmod*=3
		Enlarge_Icon(48,48)
		Center_Icon(src)
	if(A==13)
		name="Spider Zombie"
		icon='NPC Spider 3.dmi'
		Zombie_Virus=2
		Spd*=3
		spdmod*=3
		Off*=2
		offmod*=2
		Enlarge_Icon(48,48)
		Center_Icon(src)
	Level=A //This is used by the DNA detector to see what it is supposed to get from the zombie.
	overlays-=overlays
	spawn if(src&&type!=/mob/Enemy/Zombie) Zombie_Initialize()
mob/var/Has_DNA=1
obj/items/DNA_Container
	Cost=20000000
	icon='Item, DNA Extractor.dmi'
	desc="This can be used to store DNA from whoever you use it on. Which can be used to clone them. You can \
	only use this on someone who is knocked out or paralyzed. After it has DNA in it, you can go to a Genetics \
	Computer and use it to make a clone, and possibly more."
	Stealable=1
	era_reset_immune=0
	var/mob/Clone
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use()
		var/mob/A=usr
		for(var/mob/A2 in Get_step(usr,usr.dir)) if(A2.Frozen||A2.KO||!A2.client)
			A=A2
			break
		if(A in All_Entrants)
			usr<<"You can not take DNA from people enrolled in tournaments"
			return
		if(!A.Has_DNA)
			usr<<"[A] has no usable DNA"
			return
		if(A.Class=="Legendary Saiyan")
			usr<<"The legendary saiyan gene is impossible to clone"
			return
		if(A.Race=="Majin")
			usr<<"Majins are not clonable"
			return
		if(A.Android)
			usr<<"[A] is an Android, they have no DNA"
			return
		if(A.Dead)
			usr<<"[A] is dead and therefore does not have DNA"
			return
		if(Clone) switch(input("This already contains DNA do you really want to overwrite it?") in list("No","Yes"))
			if("No") return
		player_view(15,usr)<<"[usr] extracts DNA from [A]"
		if(istype(A,/mob/Enemy/Zombie))
			var/obj/O=A.Zombie_Drop()
			if(O)
				usr<<"You recieved [O]"
				O.Move(usr)
				//del(src)
		name="DNA of [A.name]"
		Clone=A.Clone()
mob/proc/Zombie_Drop()
	var/obj/O
	if(Level==1) O=new/obj/items/Antivirus(Get_step(src,dir)) //Regular
	if(Level==2) O=new/obj/items/T_Energy(Get_step(src,dir)) //Dog
	if(Level==3) O=new/obj/items/T_Heal(Get_step(src,dir)) //Licker
	if(Level==4) O=new/obj/items/T_Vitality(Get_step(src,dir)) //Hunter
	if(Level==5) O=new/obj/items/T_Strength(Get_step(src,dir)) //Tyrant
	if(Level==6) O=new/obj/items/T_Fusion(Get_step(src,dir)) //Nemesis
	if(Level==7) O=new/obj/items/T_Undying(Get_step(src,dir)) //Mr X
	if(Level==8) O=new/obj/items/T_Life(Get_step(src,dir)) //Thanatos
	if(Level==9) O=new/obj/items/T_Regeneration(Get_step(src,dir)) //Gargoyle
	if(Level==10) O=new/obj/items/T_Recovery(Get_step(src,dir)) //Reptile
	if(Level==11) O=new/obj/items/T_Snake(Get_step(src,dir)) //Snake
	if(Level==12) O=new/obj/items/T_Scorpion(Get_step(src,dir)) //Scorpion
	if(Level==13) O=new/obj/items/T_Spider(Get_step(src,dir)) //Spider
	return O
mob/proc
	Undo_all_t_injections()
		Apply_t_spider(1)
		Apply_t_scorpion(1)
		Apply_t_snake(1)
		Apply_t_recovery(1)
		Apply_t_regeneration(1)
		Apply_t_undying(1)
	Apply_t_injections(list/l)
		if(!l||!l.len) return
		for(var/v in l)
			switch(v)
				if("Spider") Apply_t_spider()
				if("Scorpion") Apply_t_scorpion()
				if("Snake") Apply_t_snake()
				if("Recovery") Apply_t_recovery()
				if("Regeneration") Apply_t_regeneration()
				if("Undying") Apply_t_undying()
	Apply_t_spider(remove=0)
		if(remove)
			if("Spider" in T_Injections)
				T_Injections-="Spider"
				Str/=1.2
				strmod/=1.2
				Off/=1.2
				offmod/=1.2
				Res*=1.44
				resmod*=1.44
				Original_Decline/=0.9
				Decline/=0.9
		else
			if(!("Spider" in T_Injections))
				T_Injections+="Spider"
				Str*=1.2
				strmod*=1.2
				Off*=1.2
				offmod*=1.2
				Res/=1.44
				resmod/=1.44
				Original_Decline*=0.9
				Decline*=0.9
	Apply_t_scorpion(remove=0)
		if(remove)
			if("Scorpion" in T_Injections)
				T_Injections-="Scorpion"
				Off/=1.2
				offmod/=1.2
				Def*=1.2
				defmod*=1.2
				Original_Decline/=0.9
				Decline/=0.9
		else
			if(!("Scorpion" in T_Injections))
				T_Injections+="Scorpion"
				Off*=1.2
				offmod*=1.2
				Def/=1.2
				defmod/=1.2
				Original_Decline*=0.9
				Decline*=0.9
	Apply_t_snake(remove=0)
		if(remove)
			if("Snake" in T_Injections)
				T_Injections-="Snake"
				Spd/=1.2
				spdmod/=1.2
				Def*=1.2
				defmod*=1.2
				Original_Decline/=0.9
				Decline/=0.9
		else
			if(!("Snake" in T_Injections))
				T_Injections+="Snake"
				Spd*=1.2
				spdmod*=1.2
				Def/=1.2
				defmod/=1.2
				Original_Decline*=0.9
				Decline*=0.9
	Apply_t_recovery(remove=0)
		if(remove)
			if("Recovery" in T_Injections)
				T_Injections-="Recovery"
				recov/=2
				Ki/=0.5
				max_ki/=0.5
				Eff/=0.5
				Original_Decline/=0.8
				Decline/=0.8
		else
			if(!("Recovery" in T_Injections))
				T_Injections+="Recovery"
				recov*=2
				Ki*=0.5
				max_ki*=0.5
				Eff*=0.5
				Original_Decline*=0.8
				Decline*=0.8
	Apply_t_regeneration(remove=0)
		if(remove)
			if("Regeneration" in T_Injections)
				T_Injections-="Regeneration"
				regen/=2
				Pow/=0.25
				formod/=0.25
				Original_Decline/=0.8
				Decline/=0.8
		else
			if(!("Regeneration" in T_Injections))
				T_Injections+="Regeneration"
				regen*=2
				Pow*=0.25
				formod*=0.25
				Original_Decline*=0.8
				Decline*=0.8
	Apply_t_undying(remove=0)
		if(remove)
			if("Undying" in T_Injections)
				T_Injections-="Undying"
				Regenerate-=1.3
				Res/=0.75
				resmod/=0.75
				Original_Decline/=0.8
				Decline/=0.8
		else
			if(!("Undying" in T_Injections))
				T_Injections+="Undying"
				Regenerate+=1.3
				Res*=0.75
				resmod*=0.75
				Original_Decline*=0.8
				Decline*=0.8
obj/items/T_Spider
	Stealable=1
	desc="x1.2 Strength. 1.2x Offense. /1.44 Resistance. Get the advantage and disadvantage of a spider! \
	Also gives a BP boost roughly worth 20 minutes of sparring."
	icon='Item, Needle.dmi'
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use()
		var/mob/A=usr.get_inject()
		if(!A) return
		if(A.Redoing_Stats)
			usr<<"They must finish redoing their stats first"
			return
		if(A.Android)
			usr<<"This has no effect on androids"
			return
		if(!("Spider" in A.T_Injections))
			A.Apply_t_spider()
			player_view(15,usr)<<"[usr] injects [A] with a mysterious needle!"
			del(src)
		else usr<<"[A] has already used [src]"
obj/items/T_Scorpion
	Stealable=1
	desc="x1.2 Offense. /1.2 Defense. Get the advantage and disadvantage of a scorpion! Also gives a BP boost \
	roughly worth 20 minutes of sparring."
	icon='Item, Needle.dmi'
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use()
		var/mob/A=usr.get_inject()
		if(!A) return
		if(A.Redoing_Stats)
			usr<<"They must finish redoing their stats first"
			return
		if(!("Scorpion" in A.T_Injections))
			A.Apply_t_scorpion()
			player_view(15,usr)<<"[usr] injects [A] with a mysterious needle!"
			del(src)
		else usr<<"[A] has already used [src]"
obj/items/T_Snake
	Stealable=1
	desc="x1.2 Speed. /1.2 Defense. Get the advantage and disadvantage of a snake! Also gives a BP boost roughly \
	worth 20 minutes of sparring."
	icon='Item, Needle.dmi'
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use()
		var/mob/A=usr.get_inject()
		if(!A) return
		if(A.Redoing_Stats)
			usr<<"They must finish redoing their stats first"
			return
		if(!("Snake" in A.T_Injections))
			A.Apply_t_snake()
			player_view(15,usr)<<"[usr] injects [A] with a mysterious needle!"
			del(src)
		else usr<<"[A] has already used [src]"
obj/items/T_Recovery
	Stealable=1
	desc="Doubles recovery but halves energy."
	icon='Item, Needle.dmi'
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use()
		var/mob/A=usr.get_inject()
		if(!A) return
		if(A.Redoing_Stats)
			usr<<"They must finish redoing their stats first"
			return
		if(A.Android)
			usr<<"This has no effect on androids"
			return
		if(!("Recovery" in A.T_Injections))
			A.Apply_t_recovery()
			player_view(15,usr)<<"[usr] injects [A] with a mysterious needle!"
			del(src)
		else usr<<"[A] has already used [src]"
obj/items/T_Regeneration
	Stealable=1
	desc="Doubles regeneration and divides force by 4 permanently making energy almost useless."
	icon='Item, Needle.dmi'
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use()
		var/mob/A=usr.get_inject()
		if(!A) return
		if(A.Redoing_Stats)
			usr<<"They must finish redoing their stats first"
			return
		if(!("Regeneration" in A.T_Injections))
			A.Apply_t_regeneration()
			player_view(15,usr)<<"[usr] injects [A] with a mysterious needle!"
			del(src)
		else usr<<"[A] has already used [src]"
obj/items/T_Energy
	Stealable=1
	desc="Raises energy to a certain level if it is below that level."
	icon='Item, Needle.dmi'
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use()
		var/mob/A=usr.get_inject()
		if(!A) return
		if(A.Redoing_Stats)
			usr<<"They must finish redoing their stats first"
			return
		if(A.max_ki<2000*A.Eff)
			A.max_ki=2000*A.Eff
			A.Original_Decline*=0.8
			A.Decline*=0.8
			player_view(15,usr)<<"[usr] injects [A] with a mysterious needle!"
			del(src)
		else usr<<"[A]'s energy is too high already to use this, it will do nothing for them"
obj/items/T_Vitality
	Stealable=1
	desc="Raises durability and resistance immensely."
	icon='Item, Needle.dmi'
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use()
		var/mob/A=usr.get_inject()
		if(!A) return
		if(A.Redoing_Stats)
			usr<<"They must finish redoing their stats first"
			return
		if(!("Vitality" in A.T_Injections))
			A.T_Injections+="Vitality"
			usr.Raise_Stats(1800,"Durability")
			usr.Raise_Stats(1800,"Resistance")
			A.Original_Decline*=0.8
			A.Decline*=0.8
			player_view(15,usr)<<"[usr] injects [A] with a mysterious needle!"
			del(src)
		else usr<<"[A] has already used [src]"
obj/items/T_Heal
	Stealable=1
	desc="Temporarily speeds up regeneration when used."
	icon='Item, Needle.dmi'
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use()
		var/mob/A=usr.get_inject()
		if(!A) return
		if(A.Redoing_Stats)
			usr<<"They must finish redoing their stats first"
			return
		if(A.Android)
			usr<<"This has no effect on androids"
			return
		if(A.tournament_override(fighters_can=0))
			usr<<"These are illegal in the tournament"
			return
		A.Alter_regen_mult(4)
		spawn if(A) A.Un_KO()
		player_view(15,usr)<<"[usr] injects [A] with a mysterious needle!"
		del(src)
obj/items/T_Fusion
	Stealable=1

	desc="This will increase your battle power but it will slowly wear off. You will be immune to the t virus while \
	this is active. No amount of damage you take will slow you down. The downside is that a bio field generator \
	will kill you like it would a zombie, and there is a 10% chance that injecting this will kill you, and your \
	BP gains will be lowered 10%."

	icon='Item, Needle.dmi'
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use()
		var/mob/A=usr.get_inject()
		if(!A) return
		if(A.Redoing_Stats)
			usr<<"They must finish redoing their stats first"
			return
		if(A.Android)
			usr<<"This has no effect on androids"
			return
		var/bp=highest_base_and_hbtc_bp**0.6 * 50
		bp=Clamp(bp,highest_base_and_hbtc_bp*0.1,highest_base_and_hbtc_bp*0.2)
		if(A.Zombie_Power<bp) A.Zombie_Power=bp
		A.overlays-='Red Eyes.dmi'
		A.overlays+='Red Eyes.dmi'
		player_view(15,usr)<<"[usr] injects [A] with a mysterious needle!"
		if(prob(10)) usr.Death("???",Force_Death=1)
		del(src)
obj/items/T_Strength
	Stealable=1
	desc="This will greatly increase strength and speed if they are under certain levels."
	icon='Item, Needle.dmi'
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use()
		var/mob/A=usr.get_inject()
		if(!A) return
		if(A.Redoing_Stats)
			usr<<"They must finish redoing their stats first"
			return
		if(!("Strength" in A.T_Injections))
			A.T_Injections+="Strength"
			usr.Raise_Stats(1800,"Strength")
			usr.Raise_Stats(1800,"Speed")
			A.Original_Decline*=0.8
			A.Decline*=0.8
			player_view(15,usr)<<"[usr] injects [A] with a mysterious needle!"
			del(src)
		else usr<<"[A] has already used [src]"
obj/items/T_Undying
	Stealable=1
	desc="This will boost your death regeneration by 1.3 points (which is a lot), but result in a 25% loss of resistance."
	icon='Item, Needle.dmi'
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use()
		var/mob/A=usr.get_inject()
		if(!A) return
		if(A.Redoing_Stats)
			usr<<"They must finish redoing their stats first"
			return
		if(A.Android)
			usr<<"This has no effect on androids"
			return
		if(!("Undying" in A.T_Injections))
			A.Apply_t_undying()
			player_view(15,usr)<<"[usr] injects [A] with a mysterious needle!"
			del(src)
		else usr<<"[A] has already used [src]"
obj/items/T_Life
	Stealable=1
	desc="This will slow your decline IMMENSELY. Extending your lifespan nearly 4x its normal amount."
	icon='Item, Needle.dmi'
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use(mob/A in view(1,usr)) if(A) if(A==usr||A.Frozen||A.KO)
		if(A.Redoing_Stats)
			usr<<"They must finish redoing their stats first"
			return
		if(A.Android)
			usr<<"This has no effect on androids"
			return
		if(!("Life" in A.T_Injections))
			A.T_Injections+="Life"
			A.Decline_Rate*=0.25
			A.Original_Decline*=0.8
			A.Decline*=0.8
			player_view(15,usr)<<"[usr] injects [A] with a mysterious needle!"
			del(src)
		else usr<<"[A] has already used [src]"
mob/var/list/T_Injections=new

mob/var
	Infected_players=0
	Infected_z=0

mob/proc/Zombie_Virus_Loop() spawn while(src)
	var/delay=20
	if(Is_Cybernetic()) delay*=3
	if(!Zombie_Virus)
		Infected_players=0
		Infected_z=0
		delay*=5
	else
		if(!Infected_z) Infected_z=z
		if(Zombie_virus_activated())
			Zombie_Virus+=0.3
			Health-=Zombie_Virus*0.2
			if(Health<=0||KO) Death("???!")

	if((z==7&&!Tournament)||Zombie_Virus<0||Zombie_Power||Android||Zombie_Immune) Zombie_Virus=0

	if(Zombie_Power)
		Zombie_Power*=0.9998
		Zombie_Power-=1
		if(Zombie_Power<1)
			Zombie_Power=0
			overlays-='Red Eyes.dmi'

	sleep(delay)

mob/proc/Zombie_virus_activated()
	if(Tournament) for(var/obj/Fighter_Spot/fs in Fighter_Spots) if(getdist(src,fs)<50&&fs.z==z)
		return
	for(var/mob/m in player_view(8,src)) if(m.client&&m!=src)
		var/nearby_players=0
		for(var/mob/m2 in view(5,src)) if(m2.client&&m2!=src) nearby_players++
		if(Infected_players>=4||nearby_players>=5||(nearby_players>=1&&Infected_z!=z&&z)) return 1
		break

mob/proc/Zombies(Can_Mutate=1,timer=150) spawn(timer) if(src&&Zombie_Virus)
	if(!z) return
	var/mob/Enemy/Zombie/Z=Zombie_Copy()
	Z.overlays+='Zombie.dmi'
	Z.underlays-='Pool of Blood.dmi'
	Z.name="Zombie"
	Z.Level=1
	del(src)
mob/var/Children=0 //How many times the zombie reproduced
mob/proc/zombie_reproduce()
	if(Level!=1) return
	if(active_zombie_list.len>=Max_Zombies)
		for(var/mob/m in active_zombie_list) if(m.loc)
			m.loc=loc
			m.update_area()
			break
	else
		Zombie_Copy()
		Children++

var/zombie_reproduce_mod=1
mob/Admin5/verb/Zombie_Reproduce_Rate()
	set category="Admin"
	zombie_reproduce_mod=input(src,"How fast?","Options",zombie_reproduce_mod) as num

proc/Zombie_mutate_loop() spawn
	while(1)
		if(!active_zombie_list.len) sleep(600)
		else
			var/mutated=0
			var/regular=0
			for(var/mob/z in active_zombie_list)
				if(z.Level==1) regular++
				else mutated++
			if(mutated/(regular+mutated)<0.25)
				var/mob/Enemy/Zombie/z=pick(active_zombie_list)
				if(z&&ismob(z)&&z.z) z.Mutate()
			sleep(600)

proc/Zombie_reproduce_loop() spawn while(1)
	if(!active_zombie_list.len) sleep(50)
	else

		for(var/area/a3 in all_areas) if(a3.name in destroyed_planets)
			var/count=0
			for(var/mob/Enemy/Zombie/z in a3.npc_list)
				count++
				del(z)
				if(count>=10) break
				sleep(1)

		var/area/a
		var/area_zombies=1.#INF
		for(var/area/a2 in all_areas) if(!(a2.name in destroyed_planets))
			var/zombies=0
			for(var/mob/Enemy/Zombie/z in a2.npc_list) if(z.z&&z.Level==1) zombies++
			if(zombies&&zombies<area_zombies)
				a=a2
				area_zombies=zombies

		if(a) for(var/mob/Enemy/Zombie/z in a.npc_list)
			if(!z.KO&&z.z&&z.Level==1)
				active_zombie_list-=z
				active_zombie_list+=z //send to end of list
				z.zombie_reproduce()
				break
		var/timer=300
		if(timer<100) timer=100
		timer/=zombie_reproduce_mod

		sleep(To_tick_lag_multiple(timer))
var/list/active_zombie_list=new

mob/proc/Zombie_Lifespan() return

mob/proc/Zombie_Initialize()
	Zombie_Door_Attack()
	Zombie_Lifespan()
	Zombie_update_area()

mob/proc/Zombie_update_area() spawn
	var/old_z=z
	while(src)
		if(z!=old_z) update_area()
		old_z=z
		sleep(600)

mob/proc/Zombie_Copy()
	var/mob/Enemy/Zombie/Q=get_cached_zombie()
	Q.loc=loc
	Q.update_area()
	Q.Enlarged=Enlarged
	Q.Zombie_Virus=Zombie_Virus
	Q.Flyer=Flyer
	Q.BP=BP
	Q.Body=Body
	Q.gravity_mastered=gravity_mastered
	Q.base_bp=base_bp
	Q.bp_mod=bp_mod
	Q.Str=Str
	Q.End=End
	Q.Res=Res
	Q.Spd=Spd
	Q.Off=Off
	Q.Def=Def
	Q.strmod=strmod
	Q.endmod=endmod
	Q.resmod=resmod
	Q.spdmod=spdmod
	Q.offmod=offmod
	Q.defmod=defmod
	Q.regen=regen
	Q.recov=recov
	Q.icon=icon
	Q.overlays=overlays
	Q.name=name
	Q.Level=Level
	if(!istype(src,/mob/Enemy/Zombie))
		Q.Str*=3
		Q.strmod*=3
		Q.Off*=3
		Q.offmod*=3
		Q.Spd/=2
		Q.spdmod/=2
		Q.End/=1.6
		Q.endmod/=1.6
		Q.Res/=1.6
		Q.resmod/=1.6
		Q.Def/=5
		Q.defmod/=5
	//Q.Target=src
	for(var/obj/Stun_Chip/A in src)
		var/obj/Stun_Chip/B=new(Q)
		B.Password=A.Password
	Q.update_area()
	return Q
mob/proc/Zombie_Door_Attack()
	spawn while(src)
		if(prob(50) && z)
			var/obj/D
			for(var/obj/Turfs/Door/T in view(5,src))
				D=T
				break
			if(D)
				var/Steps=rand(0,200)
				while(Steps&&D&&D.density)
					Steps-=1
					step_towards(src,D)
					Melee()
					sleep(3)
		sleep(rand(0,6000))
//var/Zombies=0


var/list/zombie_cache=new
mob/proc/cache_zombie()
	if(grabber) grabber.Release_grab()
	loc=null
	zombie_cache-=src
	zombie_cache+=src
	update_area()
proc/get_cached_zombie()
	for(var/mob/z in zombie_cache)
		Reset_vars(z)
		zombie_cache-=z
		active_zombie_list+=z
		return z
	return new/mob/Enemy/Zombie


mob/Enemy/Zombie
	brain_transplant_allowed=0
	npc_money_mod=3
	Zombie_Virus=1
	Spawn_Timer=0
	Savable_NPC=1
	Enlargement_Chance=0
	Dead_Zone_Immune=1
	Level=1
	New()
		Zombie_Initialize()
		active_zombie_list-=src
		active_zombie_list+=src
		spawn(30) if(src) update_area()
		..()
	Del()
		active_zombie_list-=src
		cache_zombie()
		//..()
obj/items/T_Virus_Injection
	Cost=5000000
	makes_toxic_waste=1
	icon='T Virus.dmi'
	Level=1
	Stealable=1
	Injection=1
	desc="This is a virus that creates Zombies. Inject someone with it to infect them. Even dead bodies can be \
	brought back to life in a horrible way."
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use()
		var/mob/A=usr.get_inject()
		if(!A) return
		if(istype(A,/mob/Body))
			var/mob/Body/body=A
			if(body.was_zombie)
				usr<<"The cells of this body are fried, it can not be reanimated again"
				return
		player_view(15,usr)<<"[usr] injects [A] with a mysterious needle!"
		if(istype(A,/mob/Enemy/Zombie))
			if(A.Level==1) A.Mutate()
		else
			A.Zombie_Virus+=Level
			if(!A.client) A.Zombies(timer=600) //A zombie will bust out of A soon
		del(src)
obj/items/Antivirus
	icon='Antivirus.dmi'
	Stealable=1
	Level=1
	Cost=3000000
	verb/Hotbar_use()
		set hidden=1
		Use()
	verb/Use()
		var/mob/A=usr.get_inject()
		if(!A) return
		player_view(15,usr)<<"[usr] uses the [src] on [A] and all infection disappears"
		A.Zombie_Virus=0
		A.Diarea=0
		del(src)
	verb/Synthesize()
		set src in view(1)
		var/list/L=list("Cancel")
		var/int_price_mod=0.4
		//if(usr.Res()>=10000000/usr.Intelligence**int_price_mod) L[new/obj/Bio_Field_Generator]=10000000/usr.Intelligence**int_price_mod
		if(usr.Res()>=500000/usr.Intelligence**int_price_mod) L[new/obj/items/T_Heal]=500000/usr.Intelligence**int_price_mod
		if(usr.Res()>=2000000/usr.Intelligence**int_price_mod) L[new/obj/items/T_Energy]=2000000/usr.Intelligence**int_price_mod
		if(usr.Res()>=500000/usr.Intelligence**int_price_mod) L[new/obj/items/T_Vitality]=500000/usr.Intelligence**int_price_mod
		if(usr.Res()>=500000/usr.Intelligence**int_price_mod) L[new/obj/items/T_Strength]=500000/usr.Intelligence**int_price_mod
		if(usr.Res()>=500000/usr.Intelligence**int_price_mod) L[new/obj/items/T_Fusion]=500000/usr.Intelligence**int_price_mod
		if(usr.Res()>=5000000/usr.Intelligence**int_price_mod) L[new/obj/items/T_Undying]=5000000/usr.Intelligence**int_price_mod
		if(usr.Res()>=3000000/usr.Intelligence**int_price_mod) L[new/obj/items/T_Life]=3000000/usr.Intelligence**int_price_mod
		if(usr.Res()>=5000000/usr.Intelligence**int_price_mod) L[new/obj/items/T_Regeneration]=5000000/usr.Intelligence**int_price_mod
		if(usr.Res()>=5000000/usr.Intelligence**int_price_mod) L[new/obj/items/T_Recovery]=5000000/usr.Intelligence**int_price_mod
		if(usr.Res()>=5000000/usr.Intelligence**int_price_mod) L[new/obj/items/T_Snake]=5000000/usr.Intelligence**int_price_mod
		if(usr.Res()>=5000000/usr.Intelligence**int_price_mod) L[new/obj/items/T_Scorpion]=5000000/usr.Intelligence**int_price_mod
		if(usr.Res()>=5000000/usr.Intelligence**int_price_mod) L[new/obj/items/T_Spider]=5000000/usr.Intelligence**int_price_mod
		if(L.len<=1)
			usr<<"You can not afford any of the options within this. It cost billions."
			return
		var/obj/O=input("You can synthesize and mutate this into many different uses. Choose one below. \
		NOTE: Only ones you can afford appear in this list") in L
		if(!O||O=="Cancel"||usr.Res()<L[O]) return
		switch(alert("[O] costs [Commas(L[O])] resources. Accept?","Options","Yes","No"))
			if("No") return
		if(usr.Res()<L[O])
			usr<<"You no longer have the resources needed"
			return
		usr.Alter_Res(-L[O])
		if(istype(O,/obj/items))
			var/obj/o=new O.type
			o.Move(usr)
		else O.loc=usr.loc